<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Map with Amenities</title>
  <style>
    #map {
      height: 100%;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    // Initialize the map
    var map = L.map('map').setView([0, 0], 13); // Default center and zoom level

    // Add a tile layer to the map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);

    // Query the amenities and add markers to the map
    function queryAmenities(center) {
      var query = '[out:json][timeout:25];\n' +
        '{{style:\n' +
        '  node[amenity=drinking_water] {\n' +
        '    icon-image: url("https://heduenas.github.io/athlete-amenities/drinkingtap.svg");\n' +
        '    icon-width: 18;\n' +
        '  }\n' +
        '}}\n' +
        '{{style:\n' +
        '  node[amenity=toilets] {\n' +
        '    icon-image: url("https://heduenas.github.io/athlete-amenities/toilets.svg");\n' +
        '    icon-width: 18;\n' +
        '  }\n' +
        '}}\n' +
        '(\n' +
        '  node[amenity=toilets](around:50000,' + center + ');\n' +
        '  node[amenity=drinking_water](around:50000,' + center + ');\n' +
        ');\n' +
        'out center;';

      // Make the AJAX request to Overpass API
      fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: query
      })
      .then(function(response) {
        log(response.json());
        return response.json();
      })
      .then(function(data) {
        // Clear previous markers from the map
        map.eachLayer(function(layer) {
          if (layer instanceof L.Marker) {
            map.removeLayer(layer);
          }
        });

        // Add new markers to the map
        var nodes = data.elements;
        for (var i = 0; i < nodes.length; i++) {
          var node = nodes[i];
          var lat = node.center.lat;
          var lon = node.center.lon;
          var marker = L.marker([lat, lon]).addTo(map);
        }
      })
      .catch(function(error) {
        console.error('An error occurred:', error);
      });
    }

    // Get the user's location and update the map
    function getUserLocation() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var lat = position.coords.latitude;
          var lon = position.coords.longitude;
          map.setView([lat, lon], 13); // Center the map around the user's location
          queryAmenities(lat + ',' + lon); // Query amenities around the user's location
        }, function(error) {
          console.error('Error getting user location:', error);
        });
      } else {
        console.error('Geolocation is not supported by this browser.');
      }
    }

    // Run the query whenever the map is moved
    map.on('moveend', function() {
      var center = map.getCenter();
      queryAmenities(center.lat + ',' + center.lng);
    });

    // Call the getUserLocation function to initialize the map
    getUserLocation();
  </script>
</body>
</html>
